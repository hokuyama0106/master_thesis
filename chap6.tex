\chapter{不良ピクセル解析ツールの開発と学内実験室における読み出し試験のデモンストレーション}
品質試験項目の１つである読み出し試験のデモンストレーションを学内実験室にて行った。
デモンストレーションの内容としては、4章で述べた2月にCERNで行ったチュートリアルとほぼ同じ内容である。
この章の前半では開発したツールと試験で使用するソフトウェアの概要について説明し、後にデモンストレーションの内容、各ソフトウェアの機能確認について述べる。


\section{読み出し試験結果解析ツールの開発}
品質試験における読み出し試験では、3章で述べたようにモジュールの性能確認のために不良ピクセル解析を行う。
これを円滑に行うために、ローカルデータベースシステムに組み込む形でピクセル解析ツールを開発した。
このツールについての詳細を以下に示す。

\subsection{概要}
YARRで読み出し試験を行った場合、結果ファイルはdigital scanやthreshold scanと言ったように各項目ごとにわかれて生成される。
また各結果ファイルにはモジュール上の全ピクセル結果がJSONの形で保存されている。
結果ファイルを模式的に表したものを以下に示す。

一方、品質試験の不良ピクセル解析においては、いくつかの試験結果を統一的に扱い、かつ各ピクセルごとに解析を行う必要がある。
そこで、開発した解析ツールでは複数の結果ファイルを1つのファイルにまとめ、ピクセルごとの解析処理を単純化する役割を担っている。
イメージを図\ref{analysis_tool_motivation}に示す。
あるモジュール、組み立て工程における読み出し試験結果の解析を統一的に行うためのツールである。

開発にはCERNが提供している解析フレームワークであるROOTを使用し、C++を用いた。
いくつかの試験の統一ファイルとして、ROOT内部の機能であるTreeを使用した。

実際に作ったTreeファイルと、このファイルのデータ保持のイメージをそれぞれ図\ref{analysis_tool_tree}、\ref{analysis_tool_tree_image}に示す。


\subsection{ツールの内部構造と処理の流れ}
開発したツールは、主に以下で説明する3つの実行ファイルで構成される。それぞれの役割について説明する。

\begin{description}
  \item[getDataFile.py (Python)]\mbox{}\\ 
    データベースから対象となるデータファイルを取得、キャッシュファイルとしてサーバー上の一時ディレクトリに保存
  \item[makeTree (C++)]\mbox{}\\ 
    getDataFile.pyを用いて生成されたキャッシュファイルを読み込み、Treeファイツを作成
  \item[analysis (C++)]\mbox{}\\ 
　　作成したTreeファイルを読み込み不良ピクセル解析を実行、結果値やプロットを出力
\end{description}

処理の流れのイメージを図\ref{analysis_tool_flow}に示す。

\section{読み出し試験に用いるソフトウェアの概要}
試験で用いるソフトウェアをいかに示す。
\begin{itemize}
  \item YARR
  \item MongoDB
  \item ウェブアプリケーション
  \item 中央データベースとのデータ同期ツール
  \item ピクセル解析ツール
  \item InfluxDB
  \item Grafana
  \item 電源操作用ソフト
  \item 温度読み出し用ソフト
\end{itemize}

\section{学内実験室におけるデモンストレーション}
学内実験室で開発しているソフトウェアを用いて読み出し試験を行い、実際の生産時における流れのデモンストレーションを局所的に行なった。
その詳細について以下に示す。

\subsection{デモンストレーションの流れ}

今回のデモンストレーションで確認した機能を以下に示す。
\begin{itemize}
  \item 中央データベースとローカルデータベースのデータ同期機能(モジュールIDのダウンロード、試験結果のアップロード)
  \item 読み出し試験に使う各種機能(設定ファイル生成、温度、電圧、電流モニタリング、試験結果閲覧)
  \item 結果選択とピクセル解析機能
\end{itemize}

またデモンストレーションにおける流れの概要を図\ref{demo_flow}に示す。

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[デモンストレーションの流れ]{デモンストレーションの流れ}
\label{demo_flow}
\end{figure}

\subsection{読み出し試験セットアップ}
読み出し試験に用いるハードウェアのセットアップを表\ref{readout_setup_table}、概要を図\ref{readout_setup_overview}、各ハードウェアの写真を\ref{readout_setup_picture}に示す。
各装置の詳細については付録Bに示す。

\begin{table}[tbp]
\begin{center}
\caption[各ハードウェアの性能]{各ハードウェアの性能}
\label{readout_setup_table}
  \begin{tabular}{|ll|} \hline
    1 & 2 \\ \hline
    result 1 & result 2 \\ \hline 
  \end{tabular}
\end{center}
\end{table}

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[ハードウェアセットアップの概要]{ハードウェアセットアップの概要}
\label{readout_setup_overview}
\end{figure}

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[各ハードウェアの写真]{各ハードウェアの写真}
\label{readout_setup_picture}
\end{figure}

\subsection{読み出し試験内容}
読み出し試験を通して、モジュールに与える電圧値、電流値、チップ横についているNTCから読み取れる温度を記録した。
以下の流れに沿って読み出しを行なった。

\subsection{機能確認}
\subsubsection{モジュールIDのダウンロード}
登録したモジュールのIDを機能を使ってダウンロードし、ウェブアプリケーションで確認した。
確認した画面を図\ref{download_SCC}に示す。

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[ダウンロードしたモジュールID確認画面]{ダウンロードしたモジュールID確認画面}
\label{download_SCC}
\end{figure}

\subsubsection{読み出し試験}
以下の流れで読み出し試験を行なった。読み出し試験はサーバーのシェルを用いて行う。

・設定ファイル生成

ダウンロードしたモジュールのIDを用いて、読み出しに用いる設定ファイルを生成した。
イメージを図\ref{config_retriever}、実際に生成したファイルを確認した画面を図\ref{create_config}に示す。

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[設定ファイル生成のイメージ]{設定ファイル生成のイメージ}
\label{config_retriever}
\end{figure}

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[生成ファイル確認画面]{生成ファイル確認画面}
\label{create_config}
\end{figure}

・試験実施とアップロード

上述した流れに沿って読み出し試験を実施した。試験結果は各試験の終わりに自動的にアップロードされるようなシステムとなっている。

・電圧値、電流値、温度のモニタリング

記録した値をGrafanaを使ってモニタリングをした。その様子を図\ref{monitoring_dcs}に示す。

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[DCSのモニタリング]{DCSのモニタリング}
\label{monitoring_dcs}
\end{figure}

・検索機能の確認
検索機能の確認を行った。

・試験結果の閲覧

ウェブアプリケーションを用いて、試験結果を閲覧した。その様子を図\ref{view_scan_result}、\ref{view_dcs}に示す。

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[試験結果の閲覧]{試験結果の閲覧}
\label{view_scan_result}
\end{figure}

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[各測定値の閲覧]{各測定値の閲覧}
\label{view_dcs}
\end{figure}

\subsubsection{結果選択とピクセル解析}
読み出し結果を選択し、ピクセル解析を行なった。結果選択の様子を図\ref{select_scans}、解析結果を表\ref{pixel_analysis_result}に示す。

\begin{figure}[bpt]\centering
\includegraphics[width=1cm]{figure}
\caption[scan結果選択の様子]{scan結果選択の様子}
\label{select_scans}
\end{figure}

\begin{table}[tbp]
\begin{center}
\caption[ピクセル解析結果]{ピクセル解析結果}
\label{pixel_analysis_result}
  \begin{tabular}{|ll|} \hline
    1 & 2 \\ \hline
    result 1 & result 2 \\ \hline 
  \end{tabular}
\end{center}
\end{table}

\subsubsection{試験結果アップロード}
選択した結果を中央データベースにアップロードし、各ファイルが正しくアップロードされていることを確認した。
各ファイルの存在を確認した結果を表\ref{scan_upload_pd}に示す。

\begin{table}[tbp]
\begin{center}
\caption[scan fileの存在確認]{scan fileの存在確認}
\label{scan_upload_pd}
  \begin{tabular}{|ll|} \hline
    1 & 2 \\ \hline
    result 1 & result 2 \\ \hline 
  \end{tabular}
\end{center}
\end{table}

